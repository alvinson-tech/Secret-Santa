<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secret Santa Matcher ‚ú®</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="organizerView" class="container">
        <h1>üéÖ Secret Santa Matcher ‚ú®</h1>
        
        <div class="sections-container">
            <div class="preset-section">
                <div class="preset-section">
                    <h2 class="section-heading">Presets</h2>
                    <button onclick="loadClassList()" style="background-color: var(--holiday-green);">Class 4A</button>
                </div>
            </div>
            <div class="manual-section">
                <div class="manual-section">
                    <h2 class="section-heading">Manual Entry</h2>
                    <div class="input-group">
                        <label>Number of Participants:</label>
                        <input type="number" id="participantCount" min="2" max="100" placeholder="Enter number (2-100)">
                        <button onclick="generateInputs()">Create Form</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="classList" class="class-list" style="display: none;"></div>
        <div id="participantInputs" class="participant-grid"></div>
        <button onclick="generateLinks()" id="generateButton" style="display:none">Generate Matches</button>
        <div id="links"></div>
    </div>

    <div id="revealerView" class="container" style="display:none">
        <h1>Your Secret Santa Match ü´Ç</h1>
        <div class="gift-container">
            <div class="gift-label">Click the gift to reveal!</div>
            <div class="gift-box" onclick="revealMatch()">üéÅ</div>
            <div class="name-reveal" id="nameReveal"></div>
        </div>
    </div>

    <div class="footer">
        Coded with ‚ù§Ô∏è by Alvin
    </div>

    <script>
        (function() {
            emailjs.init("ufFSTjFy0xSRzcey3"); // Replace with your actual public key
        })();

        // Add this new function for sending emails
        async function sendEmails() {
            const emailProgress = document.createElement('div');
            emailProgress.id = 'emailProgress';
            emailProgress.style.marginTop = '20px';
            emailProgress.style.padding = '10px';
            emailProgress.style.backgroundColor = 'rgba(255,255,255,0.9)';
            emailProgress.style.borderRadius = '8px';
            document.getElementById('links').appendChild(emailProgress);

            const linkItems = document.querySelectorAll('.link-item');
            let successCount = 0;

            for (const item of linkItems) {
                const name = item.querySelector('strong').textContent.replace("'s Link", '');
                const link = item.querySelector('span').textContent;
                const email = classStudentsData[name]?.email;
                
                if (!email) {
                    emailProgress.innerHTML += `<div style="color: red">‚ö†Ô∏è No email found for ${name}</div>`;
                    continue;
                }
                
                try {
                    await emailjs.send(
                        "service_f0z7tah", // Replace with your service ID
                        "template_z4kspec", // Replace with your template ID
                        {
                            to_name: name,
                            to_email: email,
                            link: link
                        }
                    );
                    successCount++;
                    emailProgress.innerHTML += `<div style="color: green">‚úÖ Sent to ${name}</div>`;
                } catch (error) {
                    emailProgress.innerHTML += `<div style="color: red">‚ùå Failed to send to ${name}: ${error.message}</div>`;
                }
            }

            emailProgress.innerHTML += `<div style="margin-top: 10px; font-weight: bold;">Completed! Sent ${successCount} of ${linkItems.length} emails.</div>`;
        }

        const classStudentsData = {
            "Mrs. Nikitha": { email: "" },
            "Lavanya": { email: "" },
            "Binusha": { email: "" },
            "Aakanksha": { email: "" },
            "Abdul Touheed": { email: "" },
            "Abhishek A": { email: "" },
            "Abhishek K": { email: "" },
            "Abhishek S S": { email: "" },
            "Aditya Suresh": { email: "" },
            "Akash Surendra": { email: "" },
            "Akshata Suresh": { email: "" },
            "Akshay H": { email: "" },
            "Alvin": { email: "" },
            "Amulya": { email: "" },
            "Anaghashree": { email: "" },
            "Ananya": { email: "" },
            "Aniketha": { email: "" },
            "Ankita": { email: "" },
            "Anushree": { email: "" },
            "Aralur Darshankumar": { email: "" },
            "Arfa Kulsum": { email: "" },
            "Arjun Sharma": { email: "" },
            "Arun Eshwaroop": { email: "" },
            "Aviraj": { email: "" },
            "Ayush": { email: "" },
            "Balaji R": { email: "" },
            "Bapugouda": { email: "" },
            "Basavaraj": { email: "" },
            "Basavaraj B": { email: "" },
            "Bharath C": { email: "" },
            "Bhargavi": { email: "" },
            "Bhavana": { email: "" },
            "Chandana Shree": { email: "" },
            "Chandan D P": { email: "" },
            "Channabasava": { email: "" },
            "Chethankumar": { email: "" },
            "Chethanashree": { email: "" },
            "Chiranth L": { email: "" },
            "Christy Shephard": { email: "" },
            "D Manohar": { email: "" },
            "D Neha": { email: "" },
            "Danish": { email: "" },
            "Darshan": { email: "" },
            "Debaditya Das": { email: "" },
            "Deekshita": { email: "" },
            "Deepthi": { email: "" },
            "Deeraj Ashok": { email: "" },
            "Dhanush D": { email: "" },
            "Dhanush Jain": { email: "" },
            "Dharshan V": { email: "" },
            "Dinesh Mange": { email: "" },
            "Disha": { email: "" },
            "E Vandana": { email: "" },
            "Vishwanath": { email: "" },
            "Abdulaziz": { email: "" },
            "Abhishek Police Patil": { email: "" },
            "Abhishek Gouda": { email: "" },
            "Akbar": { email: "" },
            "Arpita Suresh": { email: "" },
            "Aryha K S": { email: "" },
            "Ashish Gupta": { email: "" },
            "Ayesha": { email: "" },
            "Bhati Mohammed": { email: "" },
            "Bhavana A V": { email: "" },
            "Chandankumar V": { email: "" },
            "Vishesh Dhyan": { email: "" },
            "Darshan B": { email: "" },
            "Darshan C": { email: "" },
            "Darshan Chikanna": { email: "" },
            "V Prajwal": { email: "" },
            "Mythri": { email: "" }
        };

        let participants = [];
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('c');

        const classStudents = [
            "Mrs. Nikitha", "Lavanya", "Binusha", "Aakanksha", "Abdul Touheed", "Abhishek A", "Abhishek K", "Abhishek S S", 
            "Aditya Suresh", "Akash Surendra", "Akshata Suresh", "Akshay H", "Alvin", "Amulya", "Anaghashree", 
            "Ananya", "Aniketha", "Ankita", "Anushree", "Aralur Darshankumar", "Arfa Kulsum", "Arjun Sharma", 
            "Arun Eshwaroop", "Aviraj", "Ayush", "Balaji R", "Bapugouda", "Basavaraj", "Basavaraj B", "Bharath C", 
            "Bhargavi", "Bhavana", "Chandana Shree", "Chandan D P", "Channabasava", "Chethankumar", "Chethanashree", 
            "Chiranth L", "Christy Shephard", "D Manohar", "D Neha", "Danish", "Darshan", "Debaditya Das", "Deekshita", 
            "Deepthi", "Deeraj Ashok", "Dhanush D", "Dhanush Jain", "Dharshan V", "Dinesh Mange", "Disha", "E Vandana", 
            "Vishwanath", "Abdulaziz", "Abhishek Police Patil", "Abhishek Gouda", "Akbar", "Arpita Suresh", "Aryha K S", 
            "Ashish Gupta", "Ayesha", "Bhati Mohammed", "Bhavana A V", "Chandankumar V", "Vishesh Dhyan", "Darshan B", 
            "Darshan C", "Darshan Chikanna", "V Prajwal", "Mythri"
        ];

        if (code) {
            document.getElementById('revealerView').style.display = 'block';
            document.getElementById('organizerView').style.display = 'none';
        }

        function loadClassList() {
            const classList = document.getElementById('classList');
            classList.style.display = 'block';
            classList.innerHTML = '<h3 style="margin-bottom: 12px; color: var(--holiday-green);">Select Participants:</h3>';
            
            classStudents.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-item';
                div.innerHTML = `
                    <input type="checkbox" id="student-${student}" name="student-${student}" value="${student}">
                    <label for="student-${student}">${student}</label>
                `;
                classList.appendChild(div);
            });

            const selectButton = document.createElement('button');
            selectButton.textContent = 'Add Selected Students';
            selectButton.onclick = addSelectedStudents;
            classList.appendChild(selectButton);
        }

        function addSelectedStudents() {
            const selectedStudents = Array.from(document.querySelectorAll('.student-item input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedStudents.length < 2) {
                alert('Please select at least 2 students');
                return;
            }

            document.getElementById('participantCount').value = selectedStudents.length;
            generateInputs();

            const inputs = document.querySelectorAll('[name^="name"]');
            inputs.forEach((input, index) => {
                if (selectedStudents[index]) {
                    input.value = selectedStudents[index];
                }
            });

            document.getElementById('generateButton').style.display = 'block';
        }

        function generateInputs() {
            const count = parseInt(document.getElementById('participantCount').value);
            if (count < 2 || count > 100) {
                alert('Please enter a number between 2 and 100');
                return;
            }
            
            const container = document.getElementById('participantInputs');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `<input required placeholder="Participant ${i + 1}" name="name${i}">`;
                container.appendChild(div);
            }
            document.getElementById('generateButton').style.display = 'block';
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                console.error('Failed to copy text: ', err);
                return false;
            }
        }

        function generateLinks() {
            participants = [];
            const inputs = document.querySelectorAll('[name^="name"]');
            inputs.forEach(input => {
                if (input.value.trim()) {
                    participants.push(input.value.trim());
                }
            });

            if (participants.length < 2) {
                alert('Please add at least 2 participants');
                return;
            }

            let assigned = [...participants];
            do {
                assigned = assigned.sort(() => Math.random() - 0.5);
            } while (participants.some((p, i) => p === assigned[i]));

            const links = document.getElementById('links');
            links.innerHTML = '<h3 style="margin-bottom: 20px; color: var(--holiday-green);">Here is the Secret Santa List:</h3>';
            const linksGrid = document.createElement('div');
            linksGrid.className = 'links-grid';
            links.appendChild(linksGrid);

            participants.forEach((name, i) => {
                const assignment = assigned[i];
                const data = `${name}|${assignment}`;
                const encrypted = btoa(data).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
                const link = `${window.location.origin}${window.location.pathname}?c=${encrypted}`;
                
                const linkId = `link-${i}`;
                const div = document.createElement('div');
                div.className = 'link-item';
                div.innerHTML = `
                    <div class="link-text">
                        <strong>${name}'s Link</strong><br>
                        <span id="${linkId}" style="display: none">${link}</span>
                        <a href="${link}" target="_blank">Link #${String(i + 1).padStart(3, '0')}</a>
                    </div>
                    <button class="copy-btn" onclick="copyLink('${linkId}')" title="Copy Link">
                        <i class="fas fa-copy"></i>
                    </button>
                `;
                linksGrid.appendChild(div);
            });

            const emailButton = document.createElement('button');
            emailButton.innerHTML = 'üìß Send Emails to All';
            emailButton.onclick = sendEmails;
            emailButton.style.marginTop = '20px';
            emailButton.style.backgroundColor = 'var(--holiday-blue)';
            links.appendChild(emailButton);
        }

        function revealMatch() {
            try {
                const decoded = atob(code.replace(/-/g, '+').replace(/_/g, '/'));
                const [name, match] = decoded.split('|');
                
                const giftBox = document.querySelector('.gift-box');
                giftBox.style.transform = 'scale(0)';
                giftBox.style.transition = 'all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                
                setTimeout(() => {
                    const nameReveal = document.getElementById('nameReveal');
                    nameReveal.innerHTML = `
                        <p>‚ú® Ho Ho Ho! ‚ú®</p>
                        <p>${name}, you are Secret Santa for:</p>
                        <h2>${match}</h2>
                        <p>üéÑ Merry Christmas! üéÑ</p>
                        <p>Be a Good Santa üéÖ</p>
                        <p>Deliver your üéÅ gifts on time! </p>
                    `;
                    nameReveal.style.opacity = '0';
                    nameReveal.style.transform = 'translateY(20px)';
                    nameReveal.style.transition = 'all 0.5s ease-out';
                    
                    requestAnimationFrame(() => {
                        nameReveal.style.opacity = '1';
                        nameReveal.style.transform = 'translateY(0)';
                    });
                }, 800);
            } catch (error) {
                alert('Invalid or expired link!');
            }
        }

        async function copyLink(linkId) {
            const linkText = document.getElementById(linkId).textContent;
            const btn = event.target.closest('.copy-btn');
            
            try {
                await navigator.clipboard.writeText(linkText);
                btn.classList.add('success');
                btn.innerHTML = '<i class="fas fa-check"></i>';
                
                setTimeout(() => {
                    btn.classList.remove('success');
                    btn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }
    </script>
</body>
</html>
